const axios = require("axios");

// ===== COOLDOWN CONFIG =====
const cooldownTime = 30 * 1000; // 30 seconds
const cooldownMap = new Map();

// ===== STREAM HELPER (HQ) =====
async function getStreamFromURL(url) {
  const res = await axios({
    method: "GET",
    url,
    responseType: "stream",
    timeout: 45000,
    maxRedirects: 5,
    headers: {
      "User-Agent":
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
      Accept: "*/*",
      Referer: "https://www.tiktok.com/",
    },
  });
  return res.data;
}

// ===== FETCH VIDEOS =====
async function fetchTikTokVideos(query) {
  try {
    const res = await axios.get(
      "https://lyric-search-neon.vercel.app/kshitiz",
      {
        params: { keyword: query },
        timeout: 20000,
      }
    );

    if (!res.data) return [];
    if (Array.isArray(res.data)) return res.data;
    if (Array.isArray(res.data.data)) return res.data.data;

    return [];
  } catch (e) {
    console.error("API ERROR:", e.message);
    return [];
  }
}

module.exports = {
  config: {
    name: "twixtor",
    version: "2.2",
    author: "AYAN â˜ºï¸âœ¨ (HQ + cooldown by Maya)",
    role: 0,
    shortDescription: {
      en: "Anime twixtor videos (HQ)",
    },
    longDescription: {
      en: "High quality anime twixtor with cooldown",
    },
    category: "fun",
    guide: {
      en: "{p}twixtor naruto",
    },
  },

  onStart: async function ({ api, event, args }) {
    const userID = event.senderID;
    const now = Date.now();

    // ===== COOLDOWN CHECK =====
    if (cooldownMap.has(userID)) {
      const lastTime = cooldownMap.get(userID);
      const remaining = cooldownTime - (now - lastTime);

      if (remaining > 0) {
        return api.sendMessage(
          {
            body: `â³ | Slow down baby ğŸ˜¼\n\nğŸ•’ ${
              Math.ceil(remaining / 1000)
            } sec à¦ªà¦°à§‡ à¦†à¦¬à¦¾à¦° try à¦•à¦°à§‹`,
          },
          event.threadID,
          event.messageID
        );
      }
    }

    cooldownMap.set(userID, now);
    api.setMessageReaction("âœ¨", event.messageID, () => {}, true);

    const query = args.join(" ");
    if (!query) {
      cooldownMap.delete(userID);
      return api.sendMessage(
        {
          body:
            "âŒ | ğ™°ğ™½ğ™¸ğ™¼ğ™´ ğ™½ğ™°ğ™¼ğ™´ à¦¦à¦¾à¦“\n\nExample:\nğŸ‘‰ twixtor naruto",
        },
        event.threadID,
        event.messageID
      );
    }

    const searchQuery = `${query} anime twixtor edit hd`;
    const videos = await fetchTikTokVideos(searchQuery);

    if (!videos.length) {
      cooldownMap.delete(userID);
      return api.sendMessage(
        {
          body: `ğŸ˜¿ | **${query}** à¦à¦° à¦•à§‹à¦¨à§‹ twixtor à¦ªà¦¾à¦“à§Ÿà¦¾ à¦¯à¦¾à§Ÿà¦¨à¦¿`,
        },
        event.threadID,
        event.messageID
      );
    }

    // Prefer HD / highest quality
    const sorted = videos.sort((a, b) => {
      const aQ = a.hd || a.quality || 0;
      const bQ = b.hd || b.quality || 0;
      return bQ - aQ;
    });

    const pick = sorted.find(
      (v) => v.videoUrl || v.play || v.url
    );
    if (!pick) {
      cooldownMap.delete(userID);
      return api.sendMessage(
        { body: "âš ï¸ | ğ™°ğ™½ğ™¸ğ™¼ğ™´ ğš…ğ™¸ğ™³ğ™´ğ™¾ à¦ªà¦¾à¦“à§Ÿà¦¾ à¦¯à¦¾à§Ÿà¦¨à¦¿" },
        event.threadID,
        event.messageID
      );
    }

    const videoUrl = pick.videoUrl || pick.play || pick.url;

    try {
      const stream = await getStreamFromURL(videoUrl);
      await api.sendMessage(
        {
          body: `âœ¨ **${query} â€¢ Twixtor (HQ)**`,
          attachment: stream,
        },
        event.threadID,
        event.messageID
      );
    } catch (err) {
      console.error("SEND ERROR:", err.message);
      cooldownMap.delete(userID);
      api.sendMessage(
        {
          body:
            "âŒ | ğš‚ğ™¾ğšğšğšˆ ğš…ğ™¸ğ™³ğ™´ğ™¾ ğš‚ğ™´ğ™½ğ™³ à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§Ÿà§‡à¦›à§‡\nğŸ” à¦ªà¦°à§‡ à¦†à¦¬à¦¾à¦° try à¦•à¦°à§‹",
        },
        event.threadID,
        event.messageID
      );
    }
  },
};
