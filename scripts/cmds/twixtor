const axios = require('axios');

async function getStreamFromURL(url) {
  const response = await axios.get(url, { responseType: 'stream' });
  return response.data;
}

async function fetchTikTokVideos(query) {
  try {
    const response = await axios.get(
      `https://lyric-search-neon.vercel.app/kshitiz?keyword=${encodeURIComponent(query)}`
    );
    return response.data;
  } catch (error) {
    console.error(error);
    return null;
  }
}

module.exports = {
  config: {
    name: "twixtor",
    version: "1.0",
    author: "AYAN‚ò∫Ô∏è‚ú®",
    role: 0,
    shortDescription: {
      en: "Anime twixtor (VIP only)",
    },
    longDescription: {
      en: "Search and send anime twixtor videos (VIP only)",
    },
    category: "fun",
    guide: {
      en: "{p}twixtor [anime name]",
    },
  },

  onStart: async function ({ api, event, args, usersData }) {
    const userID = event.senderID;

    // ===== VIP CHECK =====
    const userData = await usersData.get(userID);
    if (!userData || userData.vip !== true) {
      return api.sendMessage(
        {
          body: "üîí | **VIP ONLY COMMAND**\n\nü•∫ Baby, ‡¶§‡ßÅ‡¶Æ‡¶ø VIP ‡¶®‡¶æ\n‚ú® ‡¶Ü‡¶ó‡ßá VIP ‡¶®‡¶æ‡¶ì ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ twixtor use ‡¶ï‡¶∞‡ßã üíã",
        },
        event.threadID,
        event.messageID
      );
    }

    // =====================
    api.setMessageReaction("‚ú®", event.messageID, () => {}, true);

    const query = args.join(" ");
    if (!query) {
      return api.sendMessage(
        { body: "‚ùå | Anime name ‡¶¶‡¶æ‡¶ì\n\nExample: twixtor naruto" },
        event.threadID,
        event.messageID
      );
    }

    const modifiedQuery = `${query} anime free twixtor`;
    const videos = await fetchTikTokVideos(modifiedQuery);

    if (!videos || !Array.isArray(videos) || videos.length === 0) {
      return api.sendMessage(
        { body: `üòø | **${query}** ‡¶è‡¶∞ ‡¶ï‡ßã‡¶®‡ßã twixtor ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø` },
        event.threadID,
        event.messageID
      );
    }

    const selectedVideo = videos[Math.floor(Math.random() * videos.length)];
    if (!selectedVideo.videoUrl) {
      return api.sendMessage(
        { body: "‚ö†Ô∏è | Video load ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá" },
        event.threadID,
        event.messageID
      );
    }

    try {
      const stream = await getStreamFromURL(selectedVideo.videoUrl);
      await api.sendMessage(
        {
          body: `‚ú® **${query} Twixtor**`,
          attachment: stream,
        },
        event.threadID,
        event.messageID
      );
    } catch (err) {
      console.error(err);
      api.sendMessage(
        {
          body: "‚ùå | Video send ‡¶ï‡¶∞‡¶§‡ßá error ‡¶π‡ßü‡ßá‡¶õ‡ßá\nüîÅ ‡¶™‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ try ‡¶ï‡¶∞‡ßã",
        },
        event.threadID,
        event.messageID
      );
    }
  },
};
