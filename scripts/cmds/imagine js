!cmd install imagine.js const axios = require("axios");
const fs = require("fs-extra");
const path = require("path");

module.exports.config = {
  name: "imagine2",
  version: "5.0.0",
  role: 0,
  author: "AYAN & Gemini",
  description: "AI image generator using Heru API",
  category: "image",
  guide: {
    en: "{pn} a beautiful girl in the rain"
  },
  countDown: 10
};

module.exports.onStart = async function ({ api, event, args }) {
  const { threadID, messageID } = event;
  const prompt = args.join(" ");

  if (!prompt) {
    return api.sendMessage("‚ú® ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶Æ‡ßç‡¶™‡¶ü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!\n‡¶Ø‡ßá‡¶Æ‡¶®: imagine a cute cat on a moon", threadID, messageID);
  }

  const waitMsg = await api.sendMessage("üé® AI ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶Æ‡ßç‡¶™‡¶ü ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶Å‡¶ï‡¶õ‡ßá...\n‡¶è‡¶ï‡¶ü‡ßÅ ‡¶∏‡¶Æ‡ßü ‡¶¶‡¶ø‡¶®‡•§", threadID);

  try {
    const cacheDir = path.join(process.cwd(), "cache");
    if (!fs.existsSync(cacheDir)) fs.mkdirSync(cacheDir, { recursive: true });
    
    const imgPath = path.join(cacheDir, `imagine_${Date.now()}.png`);

    // ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶∞ ‡¶è‡¶™‡¶ø‡¶Ü‡¶á ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï
    const API_URL = `https:// heru-apiv2.onrender.com/api/imagine?prompt=${encodeURIComponent(prompt)}`;

    const response = await axios.get(API_URL, {
      responseType: "arraybuffer",
      timeout: 60000 // ‡ßß ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶ü‡¶æ‡¶á‡¶Æ‡¶Ü‡¶â‡¶ü ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
    });

    if (response.data.length < 100) { // ‡¶Ø‡¶¶‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ ‡¶ñ‡ßÅ‡¶¨ ‡¶õ‡ßã‡¶ü ‡¶π‡ßü ‡¶§‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶®‡ßá ‡¶è‡¶∞‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶è‡¶∏‡ßá‡¶õ‡ßá
       throw new Error("Invalid image data received.");
    }

    fs.writeFileSync(imgPath, Buffer.from(response.data));

    await api.sendMessage({
      body: `‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶õ‡¶¨‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!\nüìù ‡¶™‡ßç‡¶∞‡¶Æ‡ßç‡¶™‡¶ü: ${prompt}`,
      attachment: fs.createReadStream(imgPath)
    }, threadID, () => {
      if (fs.existsSync(imgPath)) fs.unlinkSync(imgPath);
      api.unsendMessage(waitMsg.messageID);
    }, messageID);

  } catch (err) {
    console.error(err);
    api.unsendMessage(waitMsg.messageID);
    
    // ‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü ‡¶¨‡¶ø‡¶ï‡¶≤‡ßç‡¶™ (Fallback) ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá Pollinations ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞
    try {
        const fallbackURL = `https://pollinations.ai/p/${encodeURIComponent(prompt)}?width=1024&height=1024&nologo=true`;
        const res = await axios.get(fallbackURL, { responseType: "arraybuffer" });
        const fallbackPath = path.join(process.cwd(), "cache", `fallback_${Date.now()}.png`);
        
        fs.writeFileSync(fallbackPath, Buffer.from(res.data));
        return api.sendMessage({
            body: `‚úÖ (Backup API) ‡¶™‡ßç‡¶∞‡¶Æ‡ßç‡¶™‡¶ü: ${prompt}`,
            attachment: fs.createReadStream(fallbackPath)
        }, threadID, () => fs.unlinkSync(fallbackPath), messageID);
        
    } catch (fallbackErr) {
        return api.sendMessage("‚ùå ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶¨‡¶ø‡¶ú‡¶ø ‡¶Ü‡¶õ‡ßá‡•§ ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶ï‡ßç‡¶∑‡¶£ ‡¶™‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", threadID, messageID);
    }
  }
};